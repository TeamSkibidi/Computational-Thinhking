import { BLOCK_CONFIG } from "../services/trip.service.js";

// Hàm format tiền tệ
function formatCurrency(amount) {
    if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M';
    } else if (amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'K';
    }
    return amount.toString();
}

// Hàm parse giá tiền từ string
function parsePrice(priceStr) {
    if (!priceStr) return 0;
    if (typeof priceStr === 'number') return priceStr;
    // Loại bỏ các ký tự không phải số
    const numStr = priceStr.toString().replace(/[^0-9]/g, '');
    return parseInt(numStr) || 0;
}

// Tính tổng chi phí của một ngày
function calculateDayCost(dayData) {
    if (!dayData || !dayData.blocks) return 0;
    
    let total = 0;
    Object.values(dayData.blocks).forEach(items => {
        if (Array.isArray(items)) {
            items.forEach(item => {
                total += parsePrice(item.price_vnd);
            });
        }
    });
    return total;
}

// Tính tổng chi phí toàn bộ chuyến đi
export function calculateTotalCost(days) {
    if (!Array.isArray(days)) return 0;
    return days.reduce((sum, day) => sum + calculateDayCost(day), 0);
}

// Đếm tổng số điểm đến
export function countTotalPlaces(days) {
    if (!Array.isArray(days)) return 0;
    let count = 0;
    days.forEach(day => {
        if (day.blocks) {
            Object.values(day.blocks).forEach(items => {
                if (Array.isArray(items)) {
                    count += items.length;
                }
            });
        }
    });
    return count;
}

// Render thông tin Header (Thành phố, Ngày, Tags)
export function renderHeaderInfo(config, days = null) {
    console.log("renderHeaderInfo called with:", { config, days });
    console.log("days is array:", Array.isArray(days));
    console.log("ays length:", days?.length);
    
    document.getElementById('displayCity').textContent = config.city;
    const dParts = config.start_date.split('-');
    document.getElementById('displayDate').textContent = `${dParts[2]}/${dParts[1]}/${dParts[0]}`;
    document.getElementById('displayDuration').textContent = `${config.num_days} Ngày`;
    
    // Cập nhật tổng chi phí và số điểm đến nếu có dữ liệu
    if (days && Array.isArray(days) && days.length > 0) {
        const totalCost = calculateTotalCost(days);
        const totalPlaces = countTotalPlaces(days);
        const totalDistance = calculateTotalDistance(days);
        
        console.log("Calculated - Places:", totalPlaces, "Cost:", totalCost, "Distance:", totalDistance);
        
        const displayTotal = document.getElementById('displayTotal');
        const displayTotalCost = document.getElementById('displayTotalCost');
        const displayTotalDistance = document.getElementById('displayTotalDistance');
        
        if (displayTotal) {
            displayTotal.textContent = totalPlaces;
            console.log("Updated #displayTotal to:", totalPlaces);
        } else {
            console.error("#displayTotal not found!");
        }
        
        if (displayTotalCost) {
            displayTotalCost.textContent = totalCost.toLocaleString('vi-VN');
            console.log("Updated #displayTotalCost to:", totalCost);
        } else {
            console.error("#displayTotalCost not found!");
        }

        if (displayTotalDistance) {
            displayTotalDistance.textContent = totalDistance.toFixed(1);
            console.log("Updated #displayTotalDistance to:", totalDistance);
        } else {
            console.warn("#displayTotalDistance not found (optional)");
        }
    } else {
        console.warn("No valid days data:", days);
    }
}



// Render thanh điều hướng ngày (Day Navigator)
function calculateDayDistance(dayData) {
    if (!dayData || !dayData.blocks) return 0;
    
    let totalDistance = 0;
    Object.values(dayData.blocks).forEach(items => {
        if (Array.isArray(items)) {
            items.forEach(item => {
                // Lấy distance_km, nếu không có thì = 0
                const distanceKm = parseFloat(item.distance_km) || 0;
                totalDistance += distanceKm;
            });
        }
    });
    return totalDistance;
}

// ...existing code...

// Render thanh điều hướng ngày (Day Navigator)
export function renderDayNavigator(dataOrDays, activeIndex, onDayClick) {

    const days = Array.isArray(dataOrDays)
        ? dataOrDays
        : (dataOrDays && Array.isArray(dataOrDays.days) ? dataOrDays.days : []);

    if (!days.length) {
        console.warn("Không có days để render");
        return;
    }

    const nav = document.getElementById('dayNavigator');
    if (!nav) {
        console.error('Không tìm thấy element #dayNavigator');
        return;
    }

    nav.innerHTML = '';
    console.log("days truyền vào renderDayNavigator:", days);

    days.forEach((day, index) => {
        if (index > 0) {
            const connector = document.createElement('div');
            connector.className = "step-connector";
            nav.appendChild(connector);
        }

        const isActive = index === activeIndex;
        const btn = document.createElement('div');
        btn.className = `step-pill ${isActive ? 'active' : ''}`;

        // Gán sự kiện click được truyền từ bên ngoài vào
        btn.onclick = () => {
            if (typeof onDayClick === 'function') {
                onDayClick(index);
            }
        };

        const dateText = day.date || day.date_str || ''; // tùy server trả về
        
        // Tính tổng chi phí ngày
        const dayCost = calculateDayCost(day);
        const formattedCost = formatCurrency(dayCost);

        // ✅ THÊM MỚI: Tính tổng quãng đường ngày
        const dayDistance = calculateDayDistance(day);
        const formattedDistance = dayDistance > 0 ? dayDistance.toFixed(1) : '0.0';

        btn.innerHTML = `
            <span class="step-label">Ngày ${index + 1}</span>
            <span class="step-date">${dateText}</span>
            <span class="step-cost">${formattedCost}</span>
            <span class="step-distance">
                <i class="fa-solid fa-road"></i> ${formattedDistance} km
            </span>
        `;
        nav.appendChild(btn);

        // Tự động cuộn nút active ra giữa
        if (isActive) {
            setTimeout(() => {
                btn.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }, 100);
        }
    });
}


// Render nội dung chi tiết của một ngày (Timeline)
export function renderDayTimeline(dayData, direction = 'none', onRemovePlace = null) {
    const container = document.getElementById('timelineContainer');
    
    console.log("Rendering timeline for date:", dayData.date);

    // Animation logic
    container.classList.remove('animate-slide-right', 'animate-slide-left');
    void container.offsetWidth; // Force reflow
    
    if (direction === 'right') container.classList.add('animate-slide-right');
    else if (direction === 'left') container.classList.add('animate-slide-left');
    else {
        container.style.opacity = '0';
        setTimeout(() => container.style.opacity = '1', 50);
    }

    container.innerHTML = '';
    let hasContent = false;

    BLOCK_CONFIG.forEach(block => {
        const items = dayData.blocks[block.id];
        if (items && items.length > 0) {
            hasContent = true;
            
            // Session Header
            const sessionHeader = document.createElement('div');
            sessionHeader.className = "session-header";
            sessionHeader.innerHTML = `
                <div class="session-icon ${block.iconClass}">
                    <i class="fa-solid ${block.icon}" style="color:white;"></i>
                </div>
                <div class="session-title-wrapper">
                    <h2 class="session-title">${block.label}</h2>
                    <div class="session-line"></div>
                </div>
            `;
            container.appendChild(sessionHeader);

            items.forEach((item, itemIndex) => {
                // Parse travel info an toàn - hỗ trợ nhiều field names
                const travelMin = parseFloat(item.travel_min) || 
                                 parseFloat(item.travel_from_prev_min) || 
                                 parseFloat(item.travel_time) || 0;
                
                const distanceKm = parseFloat(item.distance_km) || 
                                  parseFloat(item.travel_from_prev_km) || 
                                  parseFloat(item.distance) || 0;
                
                // Hiển thị travel info nếu không phải activity đầu tiên
                if (itemIndex > 0 && (travelMin > 0 || distanceKm > 0)) {
                    const travelDiv = document.createElement('div');
                    travelDiv.className = "travel-info";
                    travelDiv.innerHTML = `
                        <div class="travel-line"></div>
                        <div class="travel-badge">
                            <i class="fa-solid fa-person-walking-luggage"></i>
                            <span>${travelMin > 0 ? Math.round(travelMin) : 0} phút</span>
                            <div class="dot-divider"></div>
                            <i class="fa-solid fa-road"></i>
                            <span>${distanceKm > 0 ? distanceKm.toFixed(1) : '0.0'} km</span>
                        </div>
                    `;
                    container.appendChild(travelDiv);
                }

                // Card Item
                const wrapper = document.createElement('div');
                wrapper.className = "timeline-item-wrapper";
                
                const line = document.createElement('div');
                line.className = "timeline-line-vertical";
                wrapper.appendChild(line);

                const dot = document.createElement('div');
                dot.className = "timeline-dot";
                wrapper.appendChild(dot);

                let iconType = 'fa-location-dot';
                if(item.type === 'eat') iconType = 'fa-utensils';
                if(item.type === 'coffee') iconType = 'fa-mug-hot';

                const priceDisplay = formatCurrency(item.price_vnd);
                const dwellMin = parsePrice(item.dwell_min) || item.dwell_min || 'N/A';
                const imageUrl = item.image_url || 'https://via.placeholder.com/300x200?text=No+Image';
                const itemName = item.name || 'Không có tên';
                const startTime = item.start || '--:--';
                const endTime = item.end || '--:--';

                const card = document.createElement('div');
                card.className = "card";
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${imageUrl}" class="card-img" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <button class="btn-remove-place" title="Xóa khỏi lịch trình">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <div>
                                <div class="time-badge">
                                    ${startTime} - ${endTime}
                                </div>
                                <h3 class="card-title">${itemName}</h3>
                            </div>
                            <div class="card-icon">
                                <i class="fa-solid ${iconType}"></i>
                            </div>
                        </div>
                        <div class="card-meta">
                            <span class="card-meta-item"><i class="fa-regular fa-clock"></i> ${dwellMin} phút</span>
                            <span class="card-meta-item"><i class="fa-solid fa-money-bill-1-wave"></i> ${priceDisplay}</span>
                        </div>
                    </div>
                `;
                const btnRemove = card.querySelector('.btn-remove-place');
                if (btnRemove && onRemovePlace) {
                    btnRemove.addEventListener('click', (e) => {
                        e.stopPropagation();
                        onRemovePlace(block.id, itemIndex, item.name);
                    });
                }
                wrapper.appendChild(card);
                container.appendChild(wrapper);
            });
                const priceDisplay = formatCurrency(item.price_vnd);
                const dwellMin = parsePrice(item.dwell_min) || item.dwell_min || 'N/A';
                const imageUrl = item.image_url || 'https://via.placeholder.com/300x200?text=No+Image';
                const itemName = item.name || 'Không có tên';
                const startTime = item.start || '--:--';
                const endTime = item.end || '--:--';

                const card = document.createElement('div');
                card.className = "card";
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${imageUrl}" class="card-img" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <button class="btn-remove-place" title="Xóa khỏi lịch trình">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <div>
                                <div class="time-badge">
                                    ${startTime} - ${endTime}
                                </div>
                                <h3 class="card-title">${itemName}</h3>
                            </div>
                            <div class="card-icon">
                                <i class="fa-solid ${iconType}"></i>
                            </div>
                        </div>
                        <div class="card-meta">
                            <span class="card-meta-item"><i class="fa-regular fa-clock"></i> ${dwellMin} phút</span>
                            <span class="card-meta-item"><i class="fa-solid fa-money-bill-1-wave"></i> ${priceDisplay}</span>
                        </div>
                    </div>
                `;
                const btnRemove = card.querySelector('.btn-remove-place');
                if (btnRemove && onRemovePlace) {
                    btnRemove.addEventListener('click', (e) => {
                        e.stopPropagation();
                        onRemovePlace(block.id, itemIndex, item.name);
                    });
                }
                wrapper.appendChild(card);
                container.appendChild(wrapper);
            });
        }
    });

    if (!hasContent) container.innerHTML = `<div class="empty-state"><p>Không có hoạt động nào trong ngày này.</p></div>`;
}


// Trong hàm renderTagsSelection, thêm event listener cho mỗi tag:
function renderTagsSelection() {
    const container = document.getElementById('tagSelectionArea');
    if (!container) {
        console.error("tagSelectionArea not found!");
        return;
    }
    
    // Clear container
    container.innerHTML = '';
    
    // Lấy tags để render
    const tagsToRender = cachedTags.length > 0 ? cachedTags : AVAILABLE_TAGS;
    const activeTags = currentConfig.preferred_tags || [];
    
    console.log("Rendering", tagsToRender.length, "tags");
    console.log("Active tags:", activeTags);
    
    // Render từng tag
    tagsToRender.forEach(tag => {
        const isActive = activeTags.includes(tag);
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `tag-btn${isActive ? ' active' : ''}`;
        btn.textContent = tag;
        btn.dataset.tag = tag;
        
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); // Ngăn đóng dropdown
            btn.classList.toggle('active');
            updateTagsSelectedText();
        });
        
        container.appendChild(btn);
    });
    
    // Cập nhật text hiển thị
    updateTagsSelectedText();
    
    console.log("Tags rendered:", tagsToRender.length);
}

function updateTagsSelectedText() {
    const textEl = document.getElementById('tagsSelectedText');
    if (!textEl) return;
    
    const selectedBtns = document.querySelectorAll('#tagSelectionArea .tag-btn.active');
    const count = selectedBtns.length;
    
    if (count === 0) {
        textEl.textContent = 'Chọn phong cách du lịch...';
        textEl.classList.remove('has-selection');
    } else if (count <= 3) {
        const names = Array.from(selectedBtns).map(btn => btn.textContent);
        textEl.textContent = names.join(', ');
        textEl.classList.add('has-selection');
    } else {
        textEl.textContent = `Đã chọn ${count} phong cách`;
        textEl.classList.add('has-selection');
    }
}

function displayDay(dayIndex) {
    if (!currentTrip || !currentTrip.days || !currentTrip.days[dayIndex]) {
        console.error('Invalid day index:', dayIndex);
        return;
    }

    const dayItinerary = currentTrip.days[dayIndex];
    const timelineContainer = document.getElementById('timelineContainer');

    // Render timeline
    timelineContainer.innerHTML = renderDayTimeline(dayItinerary);

    // Update active day nav
    document.querySelectorAll('.step-pill').forEach((pill, index) => {
        pill.classList.toggle('active', index === dayIndex);
    });

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}


